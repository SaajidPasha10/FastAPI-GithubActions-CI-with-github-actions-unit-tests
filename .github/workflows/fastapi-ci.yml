name: ğŸ” FastAPI CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Run Unit Tests with Coverage and HTML Report
      run: |
        mkdir -p test-results
        pytest tests/ \
          --cov=main \
          --cov-report=term \
          --cov-report=html:test-results/htmlcov \
          --html=test-results/report.html

    - name: ğŸ“ Upload Test Report Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pytest-html-and-coverage
        path: test-results/

    - name: ğŸš€ Start FastAPI server
      run: |
        nohup uvicorn main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
        sleep 10

    - name: âœ… Test / endpoint with curl
      run: |
        curl --fail http://localhost:8000 || (echo "âŒ Server did not respond!" && exit 1)

    - name: ğŸ“ Upload server log
      uses: actions/upload-artifact@v4
      with:
        name: server-log
        path: server.log
